# GitLab CI Template for ICD (Interface Control Document) Projects
# This template provides parameterized pipeline stages for building AsciiDoc-based ICD documents

# YAML Anchors for reusability
.ruby_setup: &ruby_setup
  image: ruby:3.2
  before_script:
    - gem install bundler
    - bundle config set --local path 'vendor/bundle'
    - bundle install

.asciidoctor_setup: &asciidoctor_setup
  image: asciidoctor/docker-asciidoctor:latest
  before_script:
    - mkdir -p ${BUILD_DIR}
    - echo "Building ${DOCUMENT_FILE} to ${OUTPUT_NAME}"

.artifact_policy: &artifact_policy
  artifacts:
    name: "${OUTPUT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${BUILD_DIR}/${OUTPUT_NAME}.pdf
      - ${BUILD_DIR}/${OUTPUT_NAME}.html
      - ${BUILD_DIR}/logs/
    expire_in: ${ARTIFACT_EXPIRATION}
    reports:
      dotenv: build.env

.branch_rules: &branch_rules
  only:
    - branches
    - tags
    - merge_requests

.master_rules: &master_rules
  only:
    - master
    - main
    - tags

# Default variables - can be overridden per project
variables:
  DOCUMENT_FILE: "icd-template.adoc"
  OUTPUT_NAME: "icd-template"
  BUILD_DIR: "build"
  ARTIFACT_EXPIRATION: "7 days"

# Pipeline stages
stages:
  - verify
  - build
  - deploy

# Verify Stage - AsciiDoc syntax and structure validation
verify:syntax:
  <<: *ruby_setup
  <<: *branch_rules
  stage: verify
  variables:
    DOCUMENT_FILE: "${DOCUMENT_FILE}"
  script:
    - echo "Verifying ${DOCUMENT_FILE}"
    - bundle exec make verify
  allow_failure: false
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gems
    paths:
      - vendor/bundle

verify:structure:
  <<: *ruby_setup
  <<: *branch_rules
  stage: verify
  variables:
    DOCUMENT_FILE: "${DOCUMENT_FILE}"
  script:
    - echo "Validating document structure for ${DOCUMENT_FILE}"
    - chmod +x scripts/verify.sh
    - ./scripts/verify.sh
  allow_failure: false
  cache:
    key: ${CI_COMMIT_REF_SLUG}-gems
    paths:
      - vendor/bundle

# Build Stage - Generate PDF and HTML outputs
build:pdf:
  <<: *asciidoctor_setup
  <<: *branch_rules
  stage: build
  variables:
    DOCUMENT_FILE: "${DOCUMENT_FILE}"
    OUTPUT_NAME: "${OUTPUT_NAME}"
    BUILD_DIR: "${BUILD_DIR}"
    ARTIFACT_EXPIRATION: "${ARTIFACT_EXPIRATION}"
  script:
    - echo "Generating PDF from ${DOCUMENT_FILE}"
    - mkdir -p ${BUILD_DIR}/logs
    - asciidoctor-pdf ${DOCUMENT_FILE} -o ${BUILD_DIR}/${OUTPUT_NAME}.pdf -a allow-uri-read 2>&1 | tee ${BUILD_DIR}/logs/pdf-build.log
    - ls -lh ${BUILD_DIR}/${OUTPUT_NAME}.pdf
    - echo "PDF_OUTPUT=${BUILD_DIR}/${OUTPUT_NAME}.pdf" >> build.env
  needs:
    - verify:syntax
    - verify:structure
  <<: *artifact_policy

build:html:
  <<: *asciidoctor_setup
  <<: *branch_rules
  stage: build
  variables:
    DOCUMENT_FILE: "${DOCUMENT_FILE}"
    OUTPUT_NAME: "${OUTPUT_NAME}"
    BUILD_DIR: "${BUILD_DIR}"
    ARTIFACT_EXPIRATION: "${ARTIFACT_EXPIRATION}"
  script:
    - echo "Generating HTML from ${DOCUMENT_FILE}"
    - mkdir -p ${BUILD_DIR}/logs
    - asciidoctor ${DOCUMENT_FILE} -o ${BUILD_DIR}/${OUTPUT_NAME}.html -a allow-uri-read 2>&1 | tee ${BUILD_DIR}/logs/html-build.log
    - ls -lh ${BUILD_DIR}/${OUTPUT_NAME}.html
    - echo "HTML_OUTPUT=${BUILD_DIR}/${OUTPUT_NAME}.html" >> build.env
  needs:
    - verify:syntax
    - verify:structure
  <<: *artifact_policy

# Build Stage - Matrix strategy for multiple document configurations
build:matrix:
  <<: *asciidoctor_setup
  <<: *branch_rules
  stage: build
  parallel:
    matrix:
      - DOCUMENT_FILE: ["icd-template.adoc"]
        OUTPUT_NAME: ["icd-template"]
        FORMAT: ["pdf", "html"]
  variables:
    BUILD_DIR: "${BUILD_DIR}"
    ARTIFACT_EXPIRATION: "${ARTIFACT_EXPIRATION}"
  script:
    - echo "Building ${DOCUMENT_FILE} to ${OUTPUT_NAME}.${FORMAT}"
    - mkdir -p ${BUILD_DIR}/logs
    - |
      if [ "${FORMAT}" = "pdf" ]; then
        asciidoctor-pdf ${DOCUMENT_FILE} -o ${BUILD_DIR}/${OUTPUT_NAME}.pdf -a allow-uri-read 2>&1 | tee ${BUILD_DIR}/logs/${OUTPUT_NAME}-pdf-build.log
      else
        asciidoctor ${DOCUMENT_FILE} -o ${BUILD_DIR}/${OUTPUT_NAME}.html -a allow-uri-read 2>&1 | tee ${BUILD_DIR}/logs/${OUTPUT_NAME}-html-build.log
      fi
    - ls -lh ${BUILD_DIR}/${OUTPUT_NAME}.${FORMAT}
    - echo "OUTPUT_FILE=${BUILD_DIR}/${OUTPUT_NAME}.${FORMAT}" >> build.env
  needs:
    - verify:syntax
    - verify:structure
  <<: *artifact_policy
  when: manual

# Deploy Stage - Publish artifacts
deploy:artifacts:
  stage: deploy
  <<: *master_rules
  image: alpine:latest
  variables:
    OUTPUT_NAME: "${OUTPUT_NAME}"
    BUILD_DIR: "${BUILD_DIR}"
  script:
    - echo "Deploying ${OUTPUT_NAME} artifacts"
    - ls -lh ${BUILD_DIR}/
    - echo "Customize this job for your deployment target (e.g., GitLab Pages, S3, Nexus)"
  dependencies:
    - build:pdf
    - build:html
  when: manual
  environment:
    name: production
    action: start

# Branch-specific artifact expiration
deploy:archive:
  stage: deploy
  <<: *master_rules
  image: alpine:latest
  variables:
    OUTPUT_NAME: "${OUTPUT_NAME}"
    BUILD_DIR: "${BUILD_DIR}"
  script:
    - echo "Archiving ${OUTPUT_NAME} for long-term storage"
    - echo "Branch: ${CI_COMMIT_REF_NAME}"
  dependencies:
    - build:pdf
    - build:html
  artifacts:
    name: "${OUTPUT_NAME}-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${BUILD_DIR}/${OUTPUT_NAME}.pdf
      - ${BUILD_DIR}/${OUTPUT_NAME}.html
    expire_in: never
  when: manual
