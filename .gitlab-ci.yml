stages:
  - verify
  - build
  - deploy

variables:
  ASCIIDOC_FILE: "icd-template.adoc"
  BUILD_DIR: "build"
  PDF_OUTPUT: "icd-template.pdf"
  HTML_OUTPUT: "icd-template.html"

# Verify job - runs verification script
# verify:
#   stage: verify
#   image: ruby:3.2
#   before_script:
#     - gem install bundler
#     - bundle config set --local path 'vendor/bundle'
#     - bundle install
#   script:
#     - chmod +x scripts/verify.sh
#     - scripts/verify.sh
#   only:
#     - branches
#     - tags
#     - merge_requests

# Build job - compiles PDF and HTML using asciidoctor
build:
  stage: build
  image: asciidoctor/docker-asciidoctor:latest
  before_script:
    - mkdir -p ${BUILD_DIR}
  script:
    - echo "Generating PDF..."
    - asciidoctor-pdf ${ASCIIDOC_FILE} -o ${BUILD_DIR}/${PDF_OUTPUT}
    - echo "PDF generated ${BUILD_DIR}/${PDF_OUTPUT}"
    - echo "Generating HTML..."
    - asciidoctor ${ASCIIDOC_FILE} -o ${BUILD_DIR}/${HTML_OUTPUT}
    - echo "HTML generated ${BUILD_DIR}/${HTML_OUTPUT}"
    - ls -lh ${BUILD_DIR}/
  artifacts:
    name: "icd-template-${CI_COMMIT_REF_NAME}-${CI_COMMIT_SHORT_SHA}"
    paths:
      - ${BUILD_DIR}/${PDF_OUTPUT}
      - ${BUILD_DIR}/${HTML_OUTPUT}
      - ${BUILD_DIR}/images/*.png
      - ${BUILD_DIR}/images/*.svg
    # Conditional expiration: never expire for master branch, 7 days for others
    expire_in: 7 days
  only:
    - branches
    - tags
    - merge_requests

# Deploy job placeholder - customize based on deployment needs
deploy:
  stage: deploy
  script:
    - echo "Deploy stage placeholder"
    - echo "Customize this job based on your deployment requirements"
    - ls -lh ${BUILD_DIR}/
  dependencies:
    - build
  only:
    - master
    - tags
  when: manual
